(function($,_){var w=this;function SchoolSelector(options,schoolData,hoster){this.lang=window.top.BSGlobal&&window.top.BSGlobal.SiteLanguage=="en"?"en":"chs";this.langbool=this.lang=="chs";this.pData={};this.hoster=hoster;this.pData.options=options||{};this.dfSearch=this.langbool?"请输入要查询的学校名称或学校关键字！":"Please enter the name or keywords of the school.";var notAllowAddSchoolArr=[103311,105478,102995,101132,185269,100102,106361,103330,101996,190014,160144,107410,103426,100399,100996,120141,101988,107965,101193];this.allowAddSchool=true;if(_.contains(notAllowAddSchoolArr,BSGlobal.TenantId))this.allowAddSchool=false;return this.init()}SchoolSelector.prototype={init:function(){this.$el=$(this.templateBox({langbool:this.langbool,allowAdd:this.allowAddSchool}));this.$provCtt=this.$el.find(".prov_box");this.$schCtt=this.$el.find(".school_box");this.winTop=w===window&&window.top,this.topBody=$(this.winTop.document.getElementsByTagName("body"));this.pData.options.denyManualAdd===true&&this.displayManualAdd();this.bindEvent();return this},ui:{mainBox:".bs_school_selector_main",searchTxt:".sl_search_box input",searchBtn:".sl_search_box .btn_s",provBtn:".prov_box .prov_list_item",radioBtn:".school_list_item input[type='radio']",currentProv:".prov_current",manualBtn:".manual_box a.manual_add",manualBtnOk:".manual_box a.manual_add_ok",manualBtnCanc:".manual_box a.manual_add_cancel",manualAddTxt:".manual_box input",manualBoxHolder:".manual_box",closeBtn:".bs_comp_close"},parseData:function(){this.pData.data=this.oriData;return this},templateBox:_.template(['<div class="bs_school_selector_main">','<h3><span class="bs_comp_title"><%=langbool ? "选择学校": "Select University" %></span> <span class="bs_comp_close">&nbsp;</span></h3>','<p id="loadingtext" style="padding:20px"><%=langbool ? "数据加载中...": "Loading..." %></p>','<div id="mainContent" style="display:none;">','<div class="sl_search_box"><input type="text" value="" class="ipt_df" /><span class="btn_s"></span></div>','<div class="prov_box"></div>','<div class="school_box"></div>','<div class="bs_cb"></div>',"<% if(allowAdd) {%>",'<div class="manual_box">','<span><%=langbool ? "没有找到目标院校？": "Can’t find what you are looking for?" %></span> <a href="javascript:void(0)" class="manual_add"><%=langbool ? "手动添加": "Add it" %></a>','<span style="display:none;" class="btn_m_add"><input type="text" value="" class="" maxlength="100"/> &nbsp; &nbsp; <a href="javascript:void(0)" class="manual_add_ok"><%=langbool ? "确定": "Ok" %></a> &nbsp;<a href="javascript:void(0)" class="manual_add_cancel"><%=langbool ? "取消": "Cancel" %></a></span>',"</div>","<% } %>","</div>","<div></div>","</div>"].join("")),tmplLoc:_.template(['<ul class="">',"<% _.each(data,function(item){ %>",'<li itemid="<%=item.id%>" class="prov_list_item"><%=item.district%></li>',"<% }) %>","</ul>"].join("")),tmplSchool:_.template(['<ul class="school_list_item">',"<% _.each(data.schools,function(item){ %>",'<li class="school_list_item">','<input type="<%=type=="multi" ? "checkbox": "radio" %>" name="abc"  itemid="<%=item.id%>"/>',"<label><%=item.name%></label></li>","<% }) %>","</ul>",'<% if(data.schools.length==0 ){ %> <p> <%=langbool ? "未搜索到相关学校！您可以手动添加学校。": "Sorry, this university can’t found. You can manually add it." %> </p><%}%>'].join("")),toDomTree:function(){this.topBody.append(this.$el);return this},showProvince:function(id){var opts=this.pData.options;opts.activeProvince=id||opts.defaultProvince;this.$provCtt.html(this.tmplLoc(this.pData));return this},showDefault:function(){var self=this;if(typeof window.schoolDataV2!=="undefined"){this.oriData=schoolDataV2;this.$el.find("#loadingtext").hide();this.$el.find("#mainContent").show();this.parseData().showProvince();this.$provCtt.find("li.prov_list_item[itemid='"+this.pData.options.defaultProvince+"']").trigger("click");this.initIptVal();this.allowAddSchool&&this.initLengthLimit();this.showMask()}else{var self=this,rootURL=this.winTop.BSGlobal?this.winTop.BSGlobal.TenantId?this.winTop.$bs_vars.constSite:this.winTop.BSGlobal.constSite:"//const.italent.cn",tenantId=this.winTop.BSGlobal?this.winTop.BSGlobal.TenantId?this.winTop.BSGlobal.TenantId:this.winTop.BSGlobal.generalData.CurrentTenant.ID:"-",lang=window.top.BSGlobal&&window.top.BSGlobal.SiteLanguage=="en"?"en":"chs",langbool=lang=="chs";settingsURL=rootURL+"/api/setting/"+tenantId;function getJSONPData(url,callback,success){$.ajax({url:url,dataType:"jsonp",jsonpCallback:callback,cache:true,success:success})}getJSONPData(settingsURL,"talentData_settingsCallback",function(settings){getJSONPData(rootURL+"/resource/Schools-"+lang+"-"+settings.Version+"-"+(settings.IsCustom?tenantId:"100000")+".js","ConstSchools",function(schools){getJSONPData("//const.italent.cn/property/Schools/Field1.js","PropertyField1",function(fd){getJSONPData(rootURL+"/resource/Areas-"+lang+"-"+settings.Version+"-"+(settings.IsCustom?tenantId:"100000")+".js","ConstAreas",function(area){schools=self.initSchoolData(schools,fd,area);window.schoolDataV2=schools;self.oriData=window.schoolDataV2;self.$el.find("#loadingtext").hide();self.$el.find("#mainContent").show();self.parseData().showProvince();self.$provCtt.find("li.prov_list_item[itemid='"+self.pData.options.defaultProvince+"']").trigger("click");self.initIptVal();self.allowAddSchool&&self.initLengthLimit();self.showMask()})})})})}return this},bindEvent:function(){this.$el.delegate(this.ui.provBtn,"click",_.bind(this.activeProv,this));this.$el.delegate(this.ui.radioBtn,"click",_.bind(this.selectSchool,this));this.$el.delegate(this.ui.searchBtn,"click",_.bind(this.searchSchool,this));this.$el.delegate(this.ui.manualBtn,"click",_.bind(this.showManualAdd,this));this.$el.delegate(this.ui.manualBtnOk,"click",_.bind(this.manualAdd,this));this.$el.delegate(this.ui.manualBtnCanc,"click",_.bind(this.hideManualAdd,this));this.$el.delegate(this.ui.closeBtn,"click",_.bind(this.close,this));this.$el.find(this.ui.searchTxt).bind("focus",_.bind(this.iptFocus,this));this.$el.find(this.ui.searchTxt).bind("blur",_.bind(this.iptBlur,this));this.$el.delegate(this.ui.searchTxt,"keypress",_.bind(this.enterThenSearch,this));return this},initIptVal:function(){var ipt=this.$el.find(this.ui.searchTxt);this.hoster.blur();ipt.addClass("ipt_df").val(this.dfSearch)},initLengthLimit:function(){var ipt=this.$el.find(this.ui.manualAddTxt);ipt.unbind("keypress").bind("keypress",function(){if(ipt.val().length>=100)return false});ipt.get(0).onpropertychange=function(){var v=ipt.val();v.length>100&&setTimeout(function(){ipt.val(v.substring(0,100))},10)}},showMask:function(){this.mask=$('<div style="opacity: 0.5; filter:alpha(opacity=50); height: 100%; width: 100%; position: fixed; left: 0px; top: 0px; z-index: 990; background-color: black;"></div>');this.topBody.append(this.mask)},initSchoolData:function(data,fd,area){var schoolArray=[],fdArray={},areaNameArray={},areaFlagArray={},tmpArray=[];$.each(area,function(i,n){areaNameArray[n[0]]=n[1][0]});$.each(data,function(i,n){schoolArray.push({id:n[0],name:n[1][0]})});$.each(fd,function(i,n){fdArray[n[0]]=n[1]});$.each(schoolArray,function(i,n){var areaId=fdArray[n.id];if(areaFlagArray[areaId]==undefined)areaFlagArray[areaId]={district:areaNameArray[areaId],id:areaId,schools:[]};areaFlagArray[areaId].schools.push(n)});var overseas=[];$.each(areaFlagArray,function(i,n){if(n.id==2){overseas.push(n);return}tmpArray.push(n)});return tmpArray.concat(overseas)},iptFocus:function(e){var ipt=$(e.currentTarget);ipt.is(".ipt_df")&&ipt.removeClass("ipt_df").val("")},iptBlur:function(e){var ipt=$(e.currentTarget);$.trim(ipt.val())==""&&ipt.addClass("ipt_df").val(this.dfSearch)},activeProv:function(e){var self=this,node=$(e.currentTarget);this.pData.options.activeProvince=node.attr("itemid");this.$el.find(this.ui.currentProv).removeClass("prov_current");node.addClass("prov_current");return this.showSchools(_.find(this.pData.data,function(item){return item.id==self.pData.options.activeProvince}))},showSchools:function(sdata){this.$schCtt.html(this.tmplSchool({data:sdata,type:this.pData.options.type,langbool:this.langbool}));return this},enterThenSearch:function(e){var c=e.keyCode;c==13&&this.searchSchool()},selectSchool:function(e){var node=$(e.currentTarget),selectedData={id:node.attr("itemid"),name:node.next().text()};this.hoster.val(selectedData.name);this.hoster.attr("data-school-id",selectedData.id);return this.close()},searchSchool:function(){var ipt=this.$el.find(this.ui.searchTxt);if(ipt.is(".ipt_df"))return;var v=$.trim(this.getSearchVal());if(!v)return;this.$el.find(this.ui.currentProv).removeClass("prov_current");var allSchool=_.flatten(_.map(this.pData.data,function(item){return item.schools}));return this.showSchools({schools:_.filter(allSchool,function(item){return item.name.indexOf(v)!=-1})})},getSearchVal:function(){return this.$el.find(this.ui.searchTxt).val()},showManualAdd:function(e){var node=$(e.currentTarget);node.hide();node.next().show();return this},manualAdd:function(){var v=this.$el.find(this.ui.manualAddTxt).val();this.hoster.val(v);this.hoster.removeAttr("data-school-id");return this.hideManualAdd().close()},hideManualAdd:function(){this.$el.find(this.ui.manualAddTxt).val("");this.$el.find(this.ui.manualBtn).show();this.$el.find(this.ui.manualBtnOk).parent().hide();return this},close:function(){this.$el.hide();this.mask.remove();return this},displayManualAdd:function(){this.$el.find(this.ui.manualBoxHolder).hide()}};$.fn.extend({schoolSelector:function(data,opt){var self=this,defaults={defaultProvince:"1100",activeProvince:"1100",type:"single"};opt=opt||{};var options=$.extend({},defaults,opt),customDenyManualAddIDs=[],customDenyManualDomains=["haixin.zhiye.com","hisense.zhiye.com"];if(BSGlobal&&BSGlobal.generalData&&BSGlobal.generalData.CurrentTenant&&BSGlobal.generalData.CurrentTenant.ID&&_.contains(customDenyManualAddIDs,BSGlobal.generalData.CurrentTenant.ID))options.denyManualAdd=true;if(_.contains(customDenyManualDomains,window.location.hostname))options.denyManualAdd=true;self.prop("readonly",true);self.click(function(){var isl=new SchoolSelector(options,data,self);isl.toDomTree();isl.showDefault().$el.show()})}})}).call(this,jQuery,_)
